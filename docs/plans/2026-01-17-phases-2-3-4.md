# Phases 2-4 Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Complete the Grant Agent platform with Knowledge Base uploads, AI-powered application generation, and production deployment.

**Architecture:** Three sequential phases: (1) KB UI wiring with upload/list/delete API routes, (2) Application Builder with RAG-based answer generation using Claude and pgvector semantic search, (3) Polish with settings page, error boundaries, and deployment config.

**Tech Stack:** Next.js 14 App Router, Supabase (PostgreSQL + pgvector), Inngest (background jobs), Claude 3.5 Sonnet (answer generation), OpenAI embeddings (text-embedding-3-large)

---

## Phase 2: Knowledge Base UI

### Task 1: KB Upload API Route

**Files:**
- Create: `app/api/kb/upload/route.ts`

**Step 1: Create the upload endpoint**

```typescript
// app/api/kb/upload/route.ts
import { createClient } from '@/lib/supabase/server';
import { inngest } from '@/lib/inngest/client';
import { NextRequest, NextResponse } from 'next/server';

const MAX_FILE_SIZE = 10 * 1024 * 1024; // 10MB
const ALLOWED_TYPES = ['application/pdf', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document', 'text/plain', 'text/csv'];

export async function POST(request: NextRequest) {
  const supabase = await createClient();

  // Check authentication
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
  }

  // Get startup for this user
  const { data: startup } = await supabase
    .from('startups')
    .select('id')
    .eq('user_id', user.id)
    .single();

  if (!startup) {
    return NextResponse.json({ error: 'No startup profile found' }, { status: 400 });
  }

  try {
    const formData = await request.formData();
    const file = formData.get('file') as File | null;

    if (!file) {
      return NextResponse.json({ error: 'No file provided' }, { status: 400 });
    }

    // Validate file size
    if (file.size > MAX_FILE_SIZE) {
      return NextResponse.json({ error: 'File too large. Maximum size is 10MB.' }, { status: 400 });
    }

    // Validate file type
    if (!ALLOWED_TYPES.includes(file.type)) {
      return NextResponse.json({ error: 'Invalid file type. Allowed: PDF, DOCX, TXT, CSV' }, { status: 400 });
    }

    // Generate unique storage path
    const timestamp = Date.now();
    const safeName = file.name.replace(/[^a-zA-Z0-9.-]/g, '_');
    const storagePath = `${startup.id}/${timestamp}-${safeName}`;

    // Upload to Supabase Storage
    const { error: uploadError } = await supabase.storage
      .from('kb-documents')
      .upload(storagePath, file);

    if (uploadError) {
      return NextResponse.json({ error: `Upload failed: ${uploadError.message}` }, { status: 500 });
    }

    // Determine file type for processing
    const fileType = file.type === 'application/pdf' ? 'pdf'
      : file.type.includes('wordprocessingml') ? 'docx'
      : file.type === 'text/csv' ? 'csv'
      : 'txt';

    // Create database record
    const { data: document, error: dbError } = await supabase
      .from('kb_documents')
      .insert({
        startup_id: startup.id,
        filename: file.name,
        file_type: fileType,
        file_size: file.size,
        storage_path: storagePath,
        status: 'pending',
      })
      .select()
      .single();

    if (dbError) {
      // Cleanup uploaded file
      await supabase.storage.from('kb-documents').remove([storagePath]);
      return NextResponse.json({ error: `Database error: ${dbError.message}` }, { status: 500 });
    }

    // Trigger processing workflow
    await inngest.send({
      name: 'kb/document.uploaded',
      data: {
        documentId: document.id,
        startupId: startup.id,
        storagePath,
        fileType,
      },
    });

    return NextResponse.json({ data: document });
  } catch (error) {
    console.error('Upload error:', error);
    return NextResponse.json({ error: 'Upload failed' }, { status: 500 });
  }
}
```

**Step 2: Verify TypeScript compiles**

Run: `npx tsc --noEmit`
Expected: No errors

**Step 3: Commit**

```bash
git add app/api/kb/upload/route.ts
git commit -m "feat(api): add KB document upload endpoint"
```

---

### Task 2: KB List & Delete API Routes

**Files:**
- Create: `app/api/kb/route.ts`
- Create: `app/api/kb/[id]/route.ts`

**Step 1: Create the list endpoint**

```typescript
// app/api/kb/route.ts
import { createClient } from '@/lib/supabase/server';
import { NextResponse } from 'next/server';

export async function GET() {
  const supabase = await createClient();

  const { data: { user } } = await supabase.auth.getUser();
  if (!user) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
  }

  const { data: startup } = await supabase
    .from('startups')
    .select('id')
    .eq('user_id', user.id)
    .single();

  if (!startup) {
    return NextResponse.json({ error: 'No startup profile found' }, { status: 400 });
  }

  const { data: documents, error } = await supabase
    .from('kb_documents')
    .select('*')
    .eq('startup_id', startup.id)
    .order('created_at', { ascending: false });

  if (error) {
    return NextResponse.json({ error: error.message }, { status: 500 });
  }

  return NextResponse.json({ data: documents });
}
```

**Step 2: Create the delete endpoint**

```typescript
// app/api/kb/[id]/route.ts
import { createClient } from '@/lib/supabase/server';
import { NextRequest, NextResponse } from 'next/server';

export async function DELETE(
  request: NextRequest,
  { params }: { params: Promise<{ id: string }> }
) {
  const { id } = await params;
  const supabase = await createClient();

  const { data: { user } } = await supabase.auth.getUser();
  if (!user) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
  }

  const { data: startup } = await supabase
    .from('startups')
    .select('id')
    .eq('user_id', user.id)
    .single();

  if (!startup) {
    return NextResponse.json({ error: 'No startup profile found' }, { status: 400 });
  }

  // Verify ownership and get storage path
  const { data: document, error: fetchError } = await supabase
    .from('kb_documents')
    .select('storage_path')
    .eq('id', id)
    .eq('startup_id', startup.id)
    .single();

  if (fetchError || !document) {
    return NextResponse.json({ error: 'Document not found' }, { status: 404 });
  }

  // Delete from storage
  await supabase.storage.from('kb-documents').remove([document.storage_path]);

  // Delete from database (cascades to kb_chunks)
  const { error: deleteError } = await supabase
    .from('kb_documents')
    .delete()
    .eq('id', id);

  if (deleteError) {
    return NextResponse.json({ error: deleteError.message }, { status: 500 });
  }

  return NextResponse.json({ success: true });
}
```

**Step 3: Verify TypeScript compiles**

Run: `npx tsc --noEmit`
Expected: No errors

**Step 4: Commit**

```bash
git add app/api/kb/route.ts app/api/kb/[id]/route.ts
git commit -m "feat(api): add KB list and delete endpoints"
```

---

### Task 3: Document Uploader Component

**Files:**
- Create: `components/kb/document-uploader.tsx`

**Step 1: Create the uploader component**

```typescript
// components/kb/document-uploader.tsx
'use client';

import { useCallback, useState } from 'react';
import { useDropzone } from 'react-dropzone';
import { Button } from '@/components/ui/button';
import { Card } from '@/components/ui/card';
import { Progress } from '@/components/ui/progress';

interface DocumentUploaderProps {
  onUploadComplete: () => void;
}

export function DocumentUploader({ onUploadComplete }: DocumentUploaderProps) {
  const [uploading, setUploading] = useState(false);
  const [progress, setProgress] = useState(0);
  const [error, setError] = useState<string | null>(null);

  const onDrop = useCallback(async (acceptedFiles: File[]) => {
    if (acceptedFiles.length === 0) return;

    const file = acceptedFiles[0];
    setUploading(true);
    setProgress(0);
    setError(null);

    try {
      const formData = new FormData();
      formData.append('file', file);

      setProgress(30);

      const response = await fetch('/api/kb/upload', {
        method: 'POST',
        body: formData,
      });

      setProgress(70);

      const result = await response.json();

      if (!response.ok) {
        throw new Error(result.error || 'Upload failed');
      }

      setProgress(100);
      onUploadComplete();
    } catch (err) {
      setError(err instanceof Error ? err.message : 'Upload failed');
    } finally {
      setUploading(false);
      setTimeout(() => setProgress(0), 1000);
    }
  }, [onUploadComplete]);

  const { getRootProps, getInputProps, isDragActive } = useDropzone({
    onDrop,
    accept: {
      'application/pdf': ['.pdf'],
      'application/vnd.openxmlformats-officedocument.wordprocessingml.document': ['.docx'],
      'text/plain': ['.txt'],
      'text/csv': ['.csv'],
    },
    maxSize: 10 * 1024 * 1024,
    multiple: false,
    disabled: uploading,
  });

  return (
    <Card className="p-6">
      <div
        {...getRootProps()}
        className={`border-2 border-dashed rounded-lg p-8 text-center cursor-pointer transition-colors
          ${isDragActive ? 'border-primary bg-primary/5' : 'border-muted-foreground/25 hover:border-primary/50'}
          ${uploading ? 'opacity-50 cursor-not-allowed' : ''}`}
      >
        <input {...getInputProps()} />
        <svg
          xmlns="http://www.w3.org/2000/svg"
          className="mx-auto h-12 w-12 text-muted-foreground mb-4"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
        >
          <path
            strokeLinecap="round"
            strokeLinejoin="round"
            strokeWidth={1}
            d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"
          />
        </svg>
        {isDragActive ? (
          <p className="text-primary font-medium">Drop the file here...</p>
        ) : (
          <>
            <p className="font-medium">Drag & drop a document here</p>
            <p className="text-sm text-muted-foreground mt-1">
              or click to browse
            </p>
            <p className="text-xs text-muted-foreground mt-2">
              PDF, DOCX, TXT, CSV (max 10MB)
            </p>
          </>
        )}
      </div>

      {uploading && (
        <div className="mt-4">
          <Progress value={progress} className="h-2" />
          <p className="text-sm text-muted-foreground mt-2 text-center">
            Uploading... {progress}%
          </p>
        </div>
      )}

      {error && (
        <div className="mt-4 p-3 bg-destructive/10 text-destructive rounded-md text-sm">
          {error}
        </div>
      )}
    </Card>
  );
}
```

**Step 2: Install react-dropzone**

Run: `npm install react-dropzone`
Expected: Package installs successfully

**Step 3: Verify TypeScript compiles**

Run: `npx tsc --noEmit`
Expected: No errors

**Step 4: Commit**

```bash
git add components/kb/document-uploader.tsx package.json package-lock.json
git commit -m "feat(ui): add DocumentUploader component with drag-drop"
```

---

### Task 4: Document List Component

**Files:**
- Create: `components/kb/document-list.tsx`

**Step 1: Create the document list component**

```typescript
// components/kb/document-list.tsx
'use client';

import { useState } from 'react';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
  AlertDialogTrigger,
} from '@/components/ui/alert-dialog';
import type { KBDocument } from '@/types';

interface DocumentListProps {
  documents: KBDocument[];
  onDelete: (id: string) => void;
}

export function DocumentList({ documents, onDelete }: DocumentListProps) {
  const [deleting, setDeleting] = useState<string | null>(null);

  const handleDelete = async (id: string) => {
    setDeleting(id);
    try {
      const response = await fetch(`/api/kb/${id}`, { method: 'DELETE' });
      if (response.ok) {
        onDelete(id);
      }
    } finally {
      setDeleting(null);
    }
  };

  const formatFileSize = (bytes: number) => {
    if (bytes < 1024) return `${bytes} B`;
    if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)} KB`;
    return `${(bytes / (1024 * 1024)).toFixed(1)} MB`;
  };

  const statusColors: Record<string, string> = {
    pending: 'bg-yellow-100 text-yellow-800',
    processing: 'bg-blue-100 text-blue-800',
    completed: 'bg-green-100 text-green-800',
    failed: 'bg-red-100 text-red-800',
  };

  const fileTypeIcons: Record<string, string> = {
    pdf: 'üìÑ',
    docx: 'üìù',
    txt: 'üìÉ',
    csv: 'üìä',
  };

  if (documents.length === 0) {
    return (
      <Card>
        <CardContent className="py-12 text-center">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            className="mx-auto h-12 w-12 text-muted-foreground mb-4"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              strokeWidth={1}
              d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
            />
          </svg>
          <p className="text-muted-foreground">No documents uploaded yet</p>
          <p className="text-sm text-muted-foreground mt-1">
            Upload your pitch decks, financials, and team profiles to power AI-generated answers.
          </p>
        </CardContent>
      </Card>
    );
  }

  return (
    <Card>
      <CardHeader>
        <CardTitle>Uploaded Documents ({documents.length})</CardTitle>
      </CardHeader>
      <CardContent>
        <div className="space-y-3">
          {documents.map((doc) => (
            <div
              key={doc.id}
              className="flex items-center justify-between p-3 border rounded-lg hover:bg-muted/50 transition-colors"
            >
              <div className="flex items-center gap-3 min-w-0">
                <span className="text-2xl">{fileTypeIcons[doc.file_type] || 'üìÑ'}</span>
                <div className="min-w-0">
                  <p className="font-medium truncate">{doc.filename}</p>
                  <p className="text-xs text-muted-foreground">
                    {formatFileSize(doc.file_size)} ‚Ä¢ {new Date(doc.created_at).toLocaleDateString()}
                  </p>
                </div>
              </div>

              <div className="flex items-center gap-2">
                <Badge className={statusColors[doc.status]} variant="secondary">
                  {doc.status === 'processing' && (
                    <svg className="animate-spin -ml-1 mr-1 h-3 w-3" fill="none" viewBox="0 0 24 24">
                      <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4" />
                      <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z" />
                    </svg>
                  )}
                  {doc.status.charAt(0).toUpperCase() + doc.status.slice(1)}
                </Badge>

                <AlertDialog>
                  <AlertDialogTrigger asChild>
                    <Button
                      variant="ghost"
                      size="icon"
                      className="text-muted-foreground hover:text-destructive"
                      disabled={deleting === doc.id}
                    >
                      <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                      </svg>
                    </Button>
                  </AlertDialogTrigger>
                  <AlertDialogContent>
                    <AlertDialogHeader>
                      <AlertDialogTitle>Delete Document</AlertDialogTitle>
                      <AlertDialogDescription>
                        Are you sure you want to delete &quot;{doc.filename}&quot;? This will also remove all extracted data and cannot be undone.
                      </AlertDialogDescription>
                    </AlertDialogHeader>
                    <AlertDialogFooter>
                      <AlertDialogCancel>Cancel</AlertDialogCancel>
                      <AlertDialogAction
                        onClick={() => handleDelete(doc.id)}
                        className="bg-destructive text-destructive-foreground hover:bg-destructive/90"
                      >
                        Delete
                      </AlertDialogAction>
                    </AlertDialogFooter>
                  </AlertDialogContent>
                </AlertDialog>
              </div>
            </div>
          ))}
        </div>
      </CardContent>
    </Card>
  );
}
```

**Step 2: Verify TypeScript compiles**

Run: `npx tsc --noEmit`
Expected: No errors

**Step 3: Commit**

```bash
git add components/kb/document-list.tsx
git commit -m "feat(ui): add DocumentList component with delete confirmation"
```

---

### Task 5: KB Component Index

**Files:**
- Create: `components/kb/index.ts`

**Step 1: Create component index**

```typescript
// components/kb/index.ts
export { DocumentUploader } from './document-uploader';
export { DocumentList } from './document-list';
```

**Step 2: Commit**

```bash
git add components/kb/index.ts
git commit -m "chore: add KB component index"
```

---

### Task 6: Knowledge Base Page

**Files:**
- Create: `app/(dashboard)/kb/page.tsx`

**Step 1: Create the KB page**

```typescript
// app/(dashboard)/kb/page.tsx
'use client';

import { useEffect, useState, useCallback } from 'react';
import { DocumentUploader } from '@/components/kb/document-uploader';
import { DocumentList } from '@/components/kb/document-list';
import { Skeleton } from '@/components/ui/skeleton';
import type { KBDocument } from '@/types';

export default function KnowledgeBasePage() {
  const [documents, setDocuments] = useState<KBDocument[]>([]);
  const [loading, setLoading] = useState(true);

  const fetchDocuments = useCallback(async () => {
    try {
      const response = await fetch('/api/kb');
      const result = await response.json();
      if (response.ok) {
        setDocuments(result.data || []);
      }
    } finally {
      setLoading(false);
    }
  }, []);

  useEffect(() => {
    fetchDocuments();
  }, [fetchDocuments]);

  // Poll for status updates when documents are processing
  useEffect(() => {
    const hasProcessing = documents.some(
      (doc) => doc.status === 'pending' || doc.status === 'processing'
    );

    if (!hasProcessing) return;

    const interval = setInterval(fetchDocuments, 5000);
    return () => clearInterval(interval);
  }, [documents, fetchDocuments]);

  const handleUploadComplete = () => {
    fetchDocuments();
  };

  const handleDelete = (id: string) => {
    setDocuments((prev) => prev.filter((doc) => doc.id !== id));
  };

  return (
    <div className="space-y-6">
      {/* Header */}
      <div>
        <h1 className="text-2xl font-bold tracking-tight">Knowledge Base</h1>
        <p className="text-muted-foreground">
          Upload documents about your startup. Our AI will use them to generate personalized grant application answers.
        </p>
      </div>

      {/* Upload Section */}
      <DocumentUploader onUploadComplete={handleUploadComplete} />

      {/* Documents List */}
      {loading ? (
        <div className="space-y-3">
          {Array.from({ length: 3 }).map((_, i) => (
            <Skeleton key={i} className="h-20 w-full" />
          ))}
        </div>
      ) : (
        <DocumentList documents={documents} onDelete={handleDelete} />
      )}

      {/* Tips Section */}
      <div className="bg-muted/50 rounded-lg p-4">
        <h3 className="font-medium mb-2">Tips for better AI answers</h3>
        <ul className="text-sm text-muted-foreground space-y-1">
          <li>‚Ä¢ Upload your pitch deck for company overview and traction data</li>
          <li>‚Ä¢ Include team bios or LinkedIn profiles for team-related questions</li>
          <li>‚Ä¢ Add financial projections or revenue data for funding questions</li>
          <li>‚Ä¢ Upload product documentation for technical descriptions</li>
        </ul>
      </div>
    </div>
  );
}
```

**Step 2: Verify TypeScript compiles**

Run: `npx tsc --noEmit`
Expected: No errors

**Step 3: Run lint**

Run: `npm run lint`
Expected: No errors

**Step 4: Commit**

```bash
git add app/\(dashboard\)/kb/page.tsx
git commit -m "feat(page): add Knowledge Base page with upload and document list"
```

---

## Phase 3: Application Builder

### Task 7: RAG Query Endpoint

**Files:**
- Create: `app/api/kb/query/route.ts`

**Step 1: Create the semantic search endpoint**

```typescript
// app/api/kb/query/route.ts
import { createClient } from '@/lib/supabase/server';
import { generateQueryEmbedding } from '@/lib/llm/document-processor';
import { NextRequest, NextResponse } from 'next/server';

export async function POST(request: NextRequest) {
  const supabase = await createClient();

  const { data: { user } } = await supabase.auth.getUser();
  if (!user) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
  }

  const { data: startup } = await supabase
    .from('startups')
    .select('id')
    .eq('user_id', user.id)
    .single();

  if (!startup) {
    return NextResponse.json({ error: 'No startup profile found' }, { status: 400 });
  }

  try {
    const { query, limit = 5, threshold = 0.7 } = await request.json();

    if (!query || typeof query !== 'string') {
      return NextResponse.json({ error: 'Query is required' }, { status: 400 });
    }

    // Generate embedding for query
    const queryEmbedding = await generateQueryEmbedding(query);

    // Search for similar chunks using pgvector
    const { data: chunks, error } = await supabase.rpc('match_kb_chunks', {
      query_embedding: queryEmbedding,
      match_startup_id: startup.id,
      match_threshold: threshold,
      match_count: limit,
    });

    if (error) {
      console.error('Search error:', error);
      return NextResponse.json({ error: 'Search failed' }, { status: 500 });
    }

    // Get document names for the chunks
    const documentIds = [...new Set(chunks?.map((c: { document_id: string }) => c.document_id) || [])];

    const { data: documents } = await supabase
      .from('kb_documents')
      .select('id, filename')
      .in('id', documentIds);

    const docMap = new Map(documents?.map((d) => [d.id, d.filename]) || []);

    // Enrich chunks with document names
    const enrichedChunks = chunks?.map((chunk: { document_id: string; content: string; similarity: number }) => ({
      ...chunk,
      document_name: docMap.get(chunk.document_id) || 'Unknown',
    })) || [];

    return NextResponse.json({ data: enrichedChunks });
  } catch (error) {
    console.error('Query error:', error);
    return NextResponse.json({ error: 'Query failed' }, { status: 500 });
  }
}
```

**Step 2: Verify TypeScript compiles**

Run: `npx tsc --noEmit`
Expected: No errors

**Step 3: Commit**

```bash
git add app/api/kb/query/route.ts
git commit -m "feat(api): add RAG semantic search endpoint"
```

---

### Task 8: Answer Generation Endpoint

**Files:**
- Create: `app/api/applications/generate/route.ts`

**Step 1: Create the answer generation endpoint**

```typescript
// app/api/applications/generate/route.ts
import { createClient } from '@/lib/supabase/server';
import { generateQueryEmbedding } from '@/lib/llm/document-processor';
import Anthropic from '@anthropic-ai/sdk';
import { NextRequest, NextResponse } from 'next/server';

let anthropic: Anthropic | null = null;
function getAnthropic(): Anthropic {
  if (!anthropic) {
    anthropic = new Anthropic({ apiKey: process.env.ANTHROPIC_API_KEY });
  }
  return anthropic;
}

export async function POST(request: NextRequest) {
  const supabase = await createClient();

  const { data: { user } } = await supabase.auth.getUser();
  if (!user) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
  }

  const { data: startup } = await supabase
    .from('startups')
    .select('*')
    .eq('user_id', user.id)
    .single();

  if (!startup) {
    return NextResponse.json({ error: 'No startup profile found' }, { status: 400 });
  }

  try {
    const { question, grantName, maxLength } = await request.json();

    if (!question) {
      return NextResponse.json({ error: 'Question is required' }, { status: 400 });
    }

    // Search for relevant context
    const queryEmbedding = await generateQueryEmbedding(question);

    const { data: chunks } = await supabase.rpc('match_kb_chunks', {
      query_embedding: queryEmbedding,
      match_startup_id: startup.id,
      match_threshold: 0.6,
      match_count: 5,
    });

    // Get document names
    const documentIds = [...new Set(chunks?.map((c: { document_id: string }) => c.document_id) || [])];
    const { data: documents } = await supabase
      .from('kb_documents')
      .select('id, filename')
      .in('id', documentIds);
    const docMap = new Map(documents?.map((d) => [d.id, d.filename]) || []);

    // Build context from chunks
    const context = chunks?.map((chunk: { content: string; document_id: string }) =>
      `[From ${docMap.get(chunk.document_id) || 'document'}]: ${chunk.content}`
    ).join('\n\n') || '';

    // Build startup profile context
    const startupContext = `
Startup: ${startup.name}
Sector: ${startup.sector}
Stage: ${startup.stage}
Location: ${startup.city}, ${startup.state}
Team Size: ${startup.team_size}
Founded: ${startup.founded_date || 'Not specified'}
${startup.is_dpiit_registered ? 'DPIIT Registered' : ''}
${startup.is_women_led ? 'Women-led' : ''}
Description: ${startup.description || 'Not provided'}
    `.trim();

    // Generate answer using Claude
    const response = await getAnthropic().messages.create({
      model: 'claude-3-5-sonnet-20241022',
      max_tokens: maxLength ? Math.min(maxLength * 2, 4000) : 2000,
      messages: [
        {
          role: 'user',
          content: `You are helping a startup founder write a compelling grant application answer.

STARTUP PROFILE:
${startupContext}

RELEVANT DOCUMENTS:
${context || 'No documents uploaded yet.'}

GRANT: ${grantName || 'Grant application'}

QUESTION: ${question}

${maxLength ? `CHARACTER LIMIT: ${maxLength} characters` : ''}

Write a professional, compelling answer that:
1. Directly addresses the question
2. Uses specific facts and data from the documents when available
3. Highlights the startup's strengths relevant to the question
4. Is concise and impactful
${maxLength ? `5. Stays within ${maxLength} characters` : ''}

If the documents don't contain relevant information, use the startup profile and write a reasonable answer that the founder can edit.

Answer:`,
        },
      ],
    });

    const content = response.content[0];
    if (content.type !== 'text') {
      throw new Error('Unexpected response format');
    }

    // Build sources array
    const sources = chunks?.map((chunk: { document_id: string; content: string; similarity: number }) => ({
      document_id: chunk.document_id,
      document_name: docMap.get(chunk.document_id) || 'Unknown',
      chunk_content: chunk.content.slice(0, 200) + '...',
      relevance_score: chunk.similarity,
    })) || [];

    return NextResponse.json({
      data: {
        answer: content.text,
        sources,
      },
    });
  } catch (error) {
    console.error('Generation error:', error);
    return NextResponse.json({ error: 'Answer generation failed' }, { status: 500 });
  }
}
```

**Step 2: Verify TypeScript compiles**

Run: `npx tsc --noEmit`
Expected: No errors

**Step 3: Commit**

```bash
git add app/api/applications/generate/route.ts
git commit -m "feat(api): add AI answer generation endpoint with RAG"
```

---

### Task 9: Application CRUD Endpoints

**Files:**
- Create: `app/api/applications/route.ts`
- Create: `app/api/applications/[id]/route.ts`

**Step 1: Create the applications list/create endpoints**

```typescript
// app/api/applications/route.ts
import { createClient } from '@/lib/supabase/server';
import { NextRequest, NextResponse } from 'next/server';

export async function GET() {
  const supabase = await createClient();

  const { data: { user } } = await supabase.auth.getUser();
  if (!user) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
  }

  const { data: startup } = await supabase
    .from('startups')
    .select('id')
    .eq('user_id', user.id)
    .single();

  if (!startup) {
    return NextResponse.json({ error: 'No startup profile' }, { status: 400 });
  }

  const { data: applications, error } = await supabase
    .from('applications')
    .select(`
      *,
      grants (id, name, provider, deadline, amount_max)
    `)
    .eq('startup_id', startup.id)
    .order('updated_at', { ascending: false });

  if (error) {
    return NextResponse.json({ error: error.message }, { status: 500 });
  }

  return NextResponse.json({ data: applications });
}

export async function POST(request: NextRequest) {
  const supabase = await createClient();

  const { data: { user } } = await supabase.auth.getUser();
  if (!user) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
  }

  const { data: startup } = await supabase
    .from('startups')
    .select('id')
    .eq('user_id', user.id)
    .single();

  if (!startup) {
    return NextResponse.json({ error: 'No startup profile' }, { status: 400 });
  }

  const { grant_id } = await request.json();

  if (!grant_id) {
    return NextResponse.json({ error: 'grant_id required' }, { status: 400 });
  }

  // Check if application already exists
  const { data: existing } = await supabase
    .from('applications')
    .select('id')
    .eq('startup_id', startup.id)
    .eq('grant_id', grant_id)
    .single();

  if (existing) {
    return NextResponse.json({ data: existing });
  }

  // Get grant questions to initialize answers
  const { data: grant } = await supabase
    .from('grants')
    .select('application_questions')
    .eq('id', grant_id)
    .single();

  const questions = grant?.application_questions || [];
  const initialAnswers = questions.map((q: { id: string; question: string; required: boolean }) => ({
    question_id: q.id,
    question: q.question,
    generated_answer: null,
    edited_answer: null,
    sources: [],
    is_edited: false,
  }));

  const { data: application, error } = await supabase
    .from('applications')
    .insert({
      startup_id: startup.id,
      grant_id,
      status: 'draft',
      answers: initialAnswers,
    })
    .select()
    .single();

  if (error) {
    return NextResponse.json({ error: error.message }, { status: 500 });
  }

  return NextResponse.json({ data: application });
}
```

**Step 2: Create the application detail/update endpoint**

```typescript
// app/api/applications/[id]/route.ts
import { createClient } from '@/lib/supabase/server';
import { NextRequest, NextResponse } from 'next/server';

export async function GET(
  request: NextRequest,
  { params }: { params: Promise<{ id: string }> }
) {
  const { id } = await params;
  const supabase = await createClient();

  const { data: { user } } = await supabase.auth.getUser();
  if (!user) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
  }

  const { data: startup } = await supabase
    .from('startups')
    .select('id')
    .eq('user_id', user.id)
    .single();

  if (!startup) {
    return NextResponse.json({ error: 'No startup profile' }, { status: 400 });
  }

  const { data: application, error } = await supabase
    .from('applications')
    .select(`
      *,
      grants (*)
    `)
    .eq('id', id)
    .eq('startup_id', startup.id)
    .single();

  if (error || !application) {
    return NextResponse.json({ error: 'Application not found' }, { status: 404 });
  }

  return NextResponse.json({ data: application });
}

export async function PATCH(
  request: NextRequest,
  { params }: { params: Promise<{ id: string }> }
) {
  const { id } = await params;
  const supabase = await createClient();

  const { data: { user } } = await supabase.auth.getUser();
  if (!user) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
  }

  const { data: startup } = await supabase
    .from('startups')
    .select('id')
    .eq('user_id', user.id)
    .single();

  if (!startup) {
    return NextResponse.json({ error: 'No startup profile' }, { status: 400 });
  }

  const updates = await request.json();

  const { data: application, error } = await supabase
    .from('applications')
    .update(updates)
    .eq('id', id)
    .eq('startup_id', startup.id)
    .select()
    .single();

  if (error) {
    return NextResponse.json({ error: error.message }, { status: 500 });
  }

  return NextResponse.json({ data: application });
}
```

**Step 3: Verify TypeScript compiles**

Run: `npx tsc --noEmit`
Expected: No errors

**Step 4: Commit**

```bash
git add app/api/applications/route.ts app/api/applications/[id]/route.ts
git commit -m "feat(api): add application CRUD endpoints"
```

---

### Task 10: Application Builder Page

**Files:**
- Create: `app/(dashboard)/applications/[id]/page.tsx`

**Step 1: Create the application builder page**

```typescript
// app/(dashboard)/applications/[id]/page.tsx
'use client';

import { useEffect, useState, use } from 'react';
import { useRouter } from 'next/navigation';
import Link from 'next/link';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Textarea } from '@/components/ui/textarea';
import { Badge } from '@/components/ui/badge';
import { Skeleton } from '@/components/ui/skeleton';
import type { Application, Grant, ApplicationAnswer } from '@/types';

interface ApplicationWithGrant extends Application {
  grants: Grant;
}

export default function ApplicationBuilderPage({
  params,
}: {
  params: Promise<{ id: string }>;
}) {
  const { id } = use(params);
  const router = useRouter();
  const [application, setApplication] = useState<ApplicationWithGrant | null>(null);
  const [loading, setLoading] = useState(true);
  const [generating, setGenerating] = useState<string | null>(null);
  const [saving, setSaving] = useState(false);

  useEffect(() => {
    async function fetchApplication() {
      const response = await fetch(`/api/applications/${id}`);
      const result = await response.json();
      if (response.ok) {
        setApplication(result.data);
      } else {
        router.push('/grants');
      }
      setLoading(false);
    }
    fetchApplication();
  }, [id, router]);

  const handleGenerateAnswer = async (questionId: string, question: string) => {
    if (!application) return;
    setGenerating(questionId);

    try {
      const questionData = application.grants.application_questions?.find(
        (q) => q.id === questionId
      );

      const response = await fetch('/api/applications/generate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          question,
          grantName: application.grants.name,
          maxLength: questionData?.max_length,
        }),
      });

      const result = await response.json();
      if (response.ok) {
        const updatedAnswers = application.answers.map((a) =>
          a.question_id === questionId
            ? { ...a, generated_answer: result.data.answer, sources: result.data.sources }
            : a
        );

        setApplication({ ...application, answers: updatedAnswers });
        await saveAnswers(updatedAnswers);
      }
    } finally {
      setGenerating(null);
    }
  };

  const handleAnswerChange = (questionId: string, value: string) => {
    if (!application) return;

    const updatedAnswers = application.answers.map((a) =>
      a.question_id === questionId
        ? { ...a, edited_answer: value, is_edited: true }
        : a
    );

    setApplication({ ...application, answers: updatedAnswers });
  };

  const saveAnswers = async (answers: ApplicationAnswer[]) => {
    setSaving(true);
    await fetch(`/api/applications/${id}`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ answers, status: 'in_progress' }),
    });
    setSaving(false);
  };

  const handleSave = () => {
    if (application) {
      saveAnswers(application.answers);
    }
  };

  if (loading) {
    return (
      <div className="max-w-4xl mx-auto space-y-6">
        <Skeleton className="h-8 w-64" />
        <Skeleton className="h-64 w-full" />
        <Skeleton className="h-64 w-full" />
      </div>
    );
  }

  if (!application) return null;

  const grant = application.grants;

  return (
    <div className="max-w-4xl mx-auto space-y-6">
      {/* Header */}
      <div className="flex items-start justify-between">
        <div>
          <Link
            href={`/grants/${grant.id}`}
            className="text-sm text-muted-foreground hover:text-primary mb-2 inline-block"
          >
            ‚Üê Back to Grant
          </Link>
          <h1 className="text-2xl font-bold">{grant.name}</h1>
          <p className="text-muted-foreground">{grant.provider}</p>
        </div>
        <div className="flex items-center gap-2">
          <Badge variant={application.status === 'draft' ? 'secondary' : 'default'}>
            {application.status}
          </Badge>
          <Button onClick={handleSave} disabled={saving}>
            {saving ? 'Saving...' : 'Save Draft'}
          </Button>
        </div>
      </div>

      {/* Questions */}
      <div className="space-y-6">
        {application.answers.map((answer, index) => {
          const questionData = grant.application_questions?.find(
            (q) => q.id === answer.question_id
          );
          const currentAnswer = answer.edited_answer || answer.generated_answer || '';
          const charCount = currentAnswer.length;
          const maxLength = questionData?.max_length;

          return (
            <Card key={answer.question_id}>
              <CardHeader>
                <CardTitle className="text-lg flex items-start gap-2">
                  <span className="flex-shrink-0 w-6 h-6 rounded-full bg-primary/10 text-primary text-sm flex items-center justify-center">
                    {index + 1}
                  </span>
                  {answer.question}
                </CardTitle>
                {questionData && (
                  <CardDescription>
                    {questionData.required && <span className="text-destructive">Required</span>}
                    {maxLength && ` ‚Ä¢ Max ${maxLength} characters`}
                  </CardDescription>
                )}
              </CardHeader>
              <CardContent className="space-y-4">
                <Textarea
                  value={currentAnswer}
                  onChange={(e) => handleAnswerChange(answer.question_id, e.target.value)}
                  placeholder="Your answer..."
                  className="min-h-[150px]"
                />

                <div className="flex items-center justify-between">
                  <div className="flex items-center gap-2">
                    <Button
                      variant="outline"
                      size="sm"
                      onClick={() => handleGenerateAnswer(answer.question_id, answer.question)}
                      disabled={generating === answer.question_id}
                    >
                      {generating === answer.question_id ? (
                        <>
                          <svg className="animate-spin -ml-1 mr-2 h-4 w-4" fill="none" viewBox="0 0 24 24">
                            <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4" />
                            <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z" />
                          </svg>
                          Generating...
                        </>
                      ) : (
                        <>
                          <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 10V3L4 14h7v7l9-11h-7z" />
                          </svg>
                          {answer.generated_answer ? 'Regenerate' : 'Generate with AI'}
                        </>
                      )}
                    </Button>

                    {answer.sources && answer.sources.length > 0 && (
                      <span className="text-xs text-muted-foreground">
                        Based on {answer.sources.length} source{answer.sources.length > 1 ? 's' : ''}
                      </span>
                    )}
                  </div>

                  <span className={`text-sm ${maxLength && charCount > maxLength ? 'text-destructive' : 'text-muted-foreground'}`}>
                    {charCount}{maxLength && ` / ${maxLength}`}
                  </span>
                </div>
              </CardContent>
            </Card>
          );
        })}
      </div>

      {/* Actions */}
      <div className="flex justify-end gap-2 pt-4 border-t">
        <Button variant="outline" asChild>
          <Link href="/applications">View All Applications</Link>
        </Button>
        <Button onClick={handleSave} disabled={saving}>
          {saving ? 'Saving...' : 'Save Draft'}
        </Button>
      </div>
    </div>
  );
}
```

**Step 2: Verify TypeScript compiles**

Run: `npx tsc --noEmit`
Expected: No errors

**Step 3: Commit**

```bash
git add app/\(dashboard\)/applications/\[id\]/page.tsx
git commit -m "feat(page): add Application Builder with AI answer generation"
```

---

### Task 11: Applications List Page

**Files:**
- Create: `app/(dashboard)/applications/page.tsx`

**Step 1: Create the applications list page**

```typescript
// app/(dashboard)/applications/page.tsx
'use client';

import { useEffect, useState } from 'react';
import Link from 'next/link';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import { Skeleton } from '@/components/ui/skeleton';
import type { Application, Grant } from '@/types';

interface ApplicationWithGrant extends Application {
  grants: Pick<Grant, 'id' | 'name' | 'provider' | 'deadline' | 'amount_max'>;
}

export default function ApplicationsPage() {
  const [applications, setApplications] = useState<ApplicationWithGrant[]>([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    async function fetchApplications() {
      const response = await fetch('/api/applications');
      const result = await response.json();
      if (response.ok) {
        setApplications(result.data || []);
      }
      setLoading(false);
    }
    fetchApplications();
  }, []);

  const statusColors: Record<string, string> = {
    draft: 'bg-gray-100 text-gray-800',
    in_progress: 'bg-blue-100 text-blue-800',
    completed: 'bg-green-100 text-green-800',
    submitted: 'bg-purple-100 text-purple-800',
  };

  const formatAmount = (amount: number | null) => {
    if (!amount) return null;
    if (amount >= 10000000) return `‚Çπ${(amount / 10000000).toFixed(1)} Cr`;
    if (amount >= 100000) return `‚Çπ${(amount / 100000).toFixed(0)} L`;
    return `‚Çπ${amount.toLocaleString('en-IN')}`;
  };

  if (loading) {
    return (
      <div className="space-y-6">
        <Skeleton className="h-8 w-48" />
        <div className="grid gap-4">
          {Array.from({ length: 3 }).map((_, i) => (
            <Skeleton key={i} className="h-32 w-full" />
          ))}
        </div>
      </div>
    );
  }

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-2xl font-bold tracking-tight">My Applications</h1>
          <p className="text-muted-foreground">
            Track and manage your grant applications.
          </p>
        </div>
        <Button asChild>
          <Link href="/grants">Find Grants</Link>
        </Button>
      </div>

      {/* Applications List */}
      {applications.length === 0 ? (
        <Card>
          <CardContent className="py-12 text-center">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              className="mx-auto h-12 w-12 text-muted-foreground mb-4"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                strokeLinecap="round"
                strokeLinejoin="round"
                strokeWidth={1}
                d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
              />
            </svg>
            <h3 className="text-lg font-medium">No applications yet</h3>
            <p className="text-muted-foreground mt-1 mb-4">
              Start applying to grants to track your progress here.
            </p>
            <Button asChild>
              <Link href="/grants">Browse Grants</Link>
            </Button>
          </CardContent>
        </Card>
      ) : (
        <div className="grid gap-4">
          {applications.map((app) => (
            <Card key={app.id} className="hover:shadow-md transition-shadow">
              <CardHeader className="pb-2">
                <div className="flex items-start justify-between">
                  <div>
                    <CardTitle className="text-lg">{app.grants.name}</CardTitle>
                    <CardDescription>{app.grants.provider}</CardDescription>
                  </div>
                  <Badge className={statusColors[app.status]} variant="secondary">
                    {app.status.replace('_', ' ')}
                  </Badge>
                </div>
              </CardHeader>
              <CardContent>
                <div className="flex items-center justify-between">
                  <div className="flex items-center gap-4 text-sm text-muted-foreground">
                    {app.grants.amount_max && (
                      <span>Up to {formatAmount(app.grants.amount_max)}</span>
                    )}
                    {app.grants.deadline && (
                      <span>
                        Deadline: {new Date(app.grants.deadline).toLocaleDateString('en-IN')}
                      </span>
                    )}
                    <span>
                      {app.answers.filter((a) => a.generated_answer || a.edited_answer).length} / {app.answers.length} questions answered
                    </span>
                  </div>
                  <Button asChild variant="outline" size="sm">
                    <Link href={`/applications/${app.id}`}>
                      {app.status === 'draft' ? 'Continue' : 'View'}
                    </Link>
                  </Button>
                </div>
              </CardContent>
            </Card>
          ))}
        </div>
      )}
    </div>
  );
}
```

**Step 2: Verify TypeScript compiles**

Run: `npx tsc --noEmit`
Expected: No errors

**Step 3: Run lint**

Run: `npm run lint`
Expected: No errors

**Step 4: Commit**

```bash
git add app/\(dashboard\)/applications/page.tsx
git commit -m "feat(page): add Applications list page"
```

---

### Task 12: Update Grant Detail with Apply Button

**Files:**
- Modify: `app/(dashboard)/grants/[id]/page.tsx`

**Step 1: Update the Start Application button to create application**

The existing button already links to `/applications/${grant.id}`. We need to create an API call to create the application first. Update the Start Application button section:

Find and replace in `app/(dashboard)/grants/[id]/page.tsx`:

```typescript
// Replace the Start Application Button component section with a client component wrapper
// For now, the existing link works because the applications/[id] page will create the application if needed
```

Actually, the current flow works - clicking "Start Application" goes to `/applications/[grantId]`. We need to create a redirect page that creates the application. Create a new file:

**Step 2: Create application redirect handler**

```typescript
// app/(dashboard)/applications/new/[grantId]/page.tsx
import { redirect } from 'next/navigation';
import { createClient } from '@/lib/supabase/server';

interface PageProps {
  params: Promise<{ grantId: string }>;
}

export default async function NewApplicationPage({ params }: PageProps) {
  const { grantId } = await params;
  const supabase = await createClient();

  const { data: { user } } = await supabase.auth.getUser();
  if (!user) {
    redirect('/login');
  }

  const { data: startup } = await supabase
    .from('startups')
    .select('id')
    .eq('user_id', user.id)
    .single();

  if (!startup) {
    redirect('/onboarding');
  }

  // Check if application exists
  const { data: existing } = await supabase
    .from('applications')
    .select('id')
    .eq('startup_id', startup.id)
    .eq('grant_id', grantId)
    .single();

  if (existing) {
    redirect(`/applications/${existing.id}`);
  }

  // Get grant questions
  const { data: grant } = await supabase
    .from('grants')
    .select('application_questions')
    .eq('id', grantId)
    .single();

  if (!grant) {
    redirect('/grants');
  }

  const questions = grant.application_questions || [];
  const initialAnswers = questions.map((q: { id: string; question: string }) => ({
    question_id: q.id,
    question: q.question,
    generated_answer: null,
    edited_answer: null,
    sources: [],
    is_edited: false,
  }));

  // Create application
  const { data: application, error } = await supabase
    .from('applications')
    .insert({
      startup_id: startup.id,
      grant_id: grantId,
      status: 'draft',
      answers: initialAnswers,
    })
    .select('id')
    .single();

  if (error || !application) {
    redirect(`/grants/${grantId}`);
  }

  redirect(`/applications/${application.id}`);
}
```

**Step 3: Update grant detail page link**

In `app/(dashboard)/grants/[id]/page.tsx`, find the Start Application button and update the href:

Change:
```tsx
<Link href={`/applications/${grant.id}`}>
```

To:
```tsx
<Link href={`/applications/new/${grant.id}`}>
```

**Step 4: Verify TypeScript compiles**

Run: `npx tsc --noEmit`
Expected: No errors

**Step 5: Commit**

```bash
git add app/\(dashboard\)/applications/new/\[grantId\]/page.tsx app/\(dashboard\)/grants/\[id\]/page.tsx
git commit -m "feat: add application creation flow from grant detail"
```

---

## Phase 4: Polish & Deploy

### Task 13: Settings Page

**Files:**
- Create: `app/(dashboard)/settings/page.tsx`

**Step 1: Create the settings page**

```typescript
// app/(dashboard)/settings/page.tsx
import { createClient } from '@/lib/supabase/server';
import { redirect } from 'next/navigation';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import { Button } from '@/components/ui/button';
import Link from 'next/link';

export default async function SettingsPage() {
  const supabase = await createClient();

  const { data: { user } } = await supabase.auth.getUser();
  if (!user) {
    redirect('/login');
  }

  const { data: startup } = await supabase
    .from('startups')
    .select('*')
    .eq('user_id', user.id)
    .single();

  if (!startup) {
    redirect('/onboarding');
  }

  // Get document count
  const { count: docCount } = await supabase
    .from('kb_documents')
    .select('*', { count: 'exact', head: true })
    .eq('startup_id', startup.id);

  // Get application count
  const { count: appCount } = await supabase
    .from('applications')
    .select('*', { count: 'exact', head: true })
    .eq('startup_id', startup.id);

  const stageLabels: Record<string, string> = {
    idea: 'Idea Stage',
    prototype: 'Prototype',
    mvp: 'MVP',
    early_revenue: 'Early Revenue',
    growth: 'Growth',
    scaling: 'Scaling',
  };

  const entityLabels: Record<string, string> = {
    proprietorship: 'Proprietorship',
    partnership: 'Partnership',
    llp: 'LLP',
    private_limited: 'Private Limited',
    not_incorporated: 'Not Incorporated',
  };

  return (
    <div className="max-w-4xl mx-auto space-y-6">
      <div>
        <h1 className="text-2xl font-bold tracking-tight">Settings</h1>
        <p className="text-muted-foreground">
          Manage your account and startup profile.
        </p>
      </div>

      {/* Account Section */}
      <Card>
        <CardHeader>
          <CardTitle>Account</CardTitle>
          <CardDescription>Your login information</CardDescription>
        </CardHeader>
        <CardContent className="space-y-4">
          <div>
            <p className="text-sm text-muted-foreground">Email</p>
            <p className="font-medium">{user.email}</p>
          </div>
          <div>
            <p className="text-sm text-muted-foreground">Member since</p>
            <p className="font-medium">
              {new Date(user.created_at).toLocaleDateString('en-IN', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
              })}
            </p>
          </div>
        </CardContent>
      </Card>

      {/* Startup Profile */}
      <Card>
        <CardHeader>
          <div className="flex items-center justify-between">
            <div>
              <CardTitle>Startup Profile</CardTitle>
              <CardDescription>Information about your startup</CardDescription>
            </div>
            <Button variant="outline" size="sm" asChild>
              <Link href="/onboarding?edit=true">Edit Profile</Link>
            </Button>
          </div>
        </CardHeader>
        <CardContent>
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <p className="text-sm text-muted-foreground">Startup Name</p>
              <p className="font-medium">{startup.name}</p>
            </div>
            <div>
              <p className="text-sm text-muted-foreground">Sector</p>
              <p className="font-medium capitalize">{startup.sector}</p>
            </div>
            <div>
              <p className="text-sm text-muted-foreground">Stage</p>
              <p className="font-medium">{stageLabels[startup.stage] || startup.stage}</p>
            </div>
            <div>
              <p className="text-sm text-muted-foreground">Entity Type</p>
              <p className="font-medium">{entityLabels[startup.entity_type] || startup.entity_type}</p>
            </div>
            <div>
              <p className="text-sm text-muted-foreground">Location</p>
              <p className="font-medium">{startup.city}, {startup.state}</p>
            </div>
            <div>
              <p className="text-sm text-muted-foreground">Team Size</p>
              <p className="font-medium">{startup.team_size} members</p>
            </div>
            <div className="flex gap-2">
              {startup.is_dpiit_registered && (
                <Badge variant="secondary">DPIIT Registered</Badge>
              )}
              {startup.is_women_led && (
                <Badge variant="secondary">Women-led</Badge>
              )}
            </div>
          </div>
        </CardContent>
      </Card>

      {/* Usage Stats */}
      <Card>
        <CardHeader>
          <CardTitle>Usage</CardTitle>
          <CardDescription>Your platform activity</CardDescription>
        </CardHeader>
        <CardContent>
          <div className="grid grid-cols-2 gap-4">
            <div className="text-center p-4 bg-muted/50 rounded-lg">
              <p className="text-3xl font-bold">{docCount || 0}</p>
              <p className="text-sm text-muted-foreground">Documents Uploaded</p>
            </div>
            <div className="text-center p-4 bg-muted/50 rounded-lg">
              <p className="text-3xl font-bold">{appCount || 0}</p>
              <p className="text-sm text-muted-foreground">Applications Started</p>
            </div>
          </div>
        </CardContent>
      </Card>

      {/* Danger Zone */}
      <Card className="border-destructive/50">
        <CardHeader>
          <CardTitle className="text-destructive">Danger Zone</CardTitle>
          <CardDescription>Irreversible actions</CardDescription>
        </CardHeader>
        <CardContent>
          <form action="/auth/signout" method="post">
            <Button variant="outline" type="submit">
              Sign Out
            </Button>
          </form>
        </CardContent>
      </Card>
    </div>
  );
}
```

**Step 2: Verify TypeScript compiles**

Run: `npx tsc --noEmit`
Expected: No errors

**Step 3: Commit**

```bash
git add app/\(dashboard\)/settings/page.tsx
git commit -m "feat(page): add Settings page with profile and usage stats"
```

---

### Task 14: Sign Out Route

**Files:**
- Create: `app/auth/signout/route.ts`

**Step 1: Create sign out handler**

```typescript
// app/auth/signout/route.ts
import { createClient } from '@/lib/supabase/server';
import { NextResponse } from 'next/server';

export async function POST() {
  const supabase = await createClient();
  await supabase.auth.signOut();

  return NextResponse.redirect(new URL('/login', process.env.NEXT_PUBLIC_SITE_URL || 'http://localhost:3000'));
}
```

**Step 2: Commit**

```bash
git add app/auth/signout/route.ts
git commit -m "feat(auth): add sign out route"
```

---

### Task 15: Update Sidebar Navigation

**Files:**
- Modify: `components/layout/sidebar.tsx`

**Step 1: Read current sidebar**

Check the current sidebar implementation and add KB, Applications, and Settings links.

**Step 2: Update sidebar with new navigation items**

Ensure the sidebar includes these navigation items:
- Dashboard (/)
- Grants (/grants)
- Knowledge Base (/kb)
- Applications (/applications)
- Settings (/settings)

**Step 3: Commit**

```bash
git add components/layout/sidebar.tsx
git commit -m "feat(ui): update sidebar navigation with KB, Applications, Settings"
```

---

### Task 16: Final Verification

**Step 1: Run TypeScript check**

Run: `npx tsc --noEmit`
Expected: No errors

**Step 2: Run lint**

Run: `npm run lint`
Expected: No errors

**Step 3: Final commit**

```bash
git add -A
git commit -m "feat: complete Phases 2-4 (KB UI, Application Builder, Polish)"
```

---

## Summary

This plan implements:

**Phase 2: Knowledge Base UI**
- Upload API with file validation and Inngest trigger
- List and delete endpoints with ownership checks
- DocumentUploader with drag-drop
- DocumentList with status tracking
- KB page with polling for processing status

**Phase 3: Application Builder**
- RAG query endpoint using pgvector semantic search
- AI answer generation with Claude using KB context
- Application CRUD endpoints
- Application Builder page with per-question generation
- Applications list page

**Phase 4: Polish & Deploy**
- Settings page with profile and usage stats
- Sign out route
- Updated sidebar navigation

**Testing approach:** TypeScript verification and lint after each task.

**Next phase:** Production deployment configuration, error boundaries, loading states.
